source_dir: .git/hooks

pre-commit:
  parallel: true
  commands:
    typecheck:
      run: npm run typecheck
    lint:
      run: npm run lint
      stage_fixed: true
    format:
      run: npx prettier --check .
      stage_fixed: true

commit-msg:
  commands:
    commitlint:
      run: npx commitlint --edit {1}

pre-push:
  parallel: false # Sequencial para garantir ordem correta
  commands:
    validate-basics:
      run: |
        echo "ğŸ” ValidaÃ§Ã£o bÃ¡sica..."
        npm run validate:fast
    test:
      run: |
        echo "ğŸ§ª Rodando testes..."
        npm test -- --passWithNoTests
        TEST_EXIT_CODE=$?

        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "âš ï¸  Testes falharam. Tentando atualizar snapshots..."
          npm run test:snapshots
          SNAPSHOT_EXIT_CODE=$?

          if [ $SNAPSHOT_EXIT_CODE -eq 0 ]; then
            echo "âœ… Snapshots atualizados com sucesso!"
            git add "**/__snapshots__/**" 2>/dev/null || true
            echo "ğŸ“¸ Snapshots adicionados ao commit"
            exit 0
          else
            echo "âŒ TESTES FALHARAM mesmo apÃ³s atualizar snapshots!"
            echo "âŒ Corrija os erros de teste antes de fazer push."
            exit 1
          fi
        else
          echo "âœ… Todos os testes passaram!"
          exit 0
        fi
      fail_text: "âŒ PUSH BLOQUEADO! HÃ¡ testes falhando. Corrija antes de fazer push."
    sonar-doublecheck:
      run: |
        echo "ğŸ” SonarQube Double-Check..."

        # Obter arquivos modificados que ainda nÃ£o foram commitados
        STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

        # Obter arquivos modificados em relaÃ§Ã£o ao commit anterior
        MODIFIED_FILES=$(git diff HEAD~1 --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

        ALL_FILES="$STAGED_FILES $MODIFIED_FILES"

        if [ -z "$ALL_FILES" ]; then
          echo "â„¹ï¸  Nenhum arquivo TS/JS modificado encontrado"
          echo "âœ… Prosseguindo sem anÃ¡lise SonarQube"
        else
          if npm run --silent sonar:summary >/dev/null 2>&1; then
            echo "ğŸ“Š Executando npm run sonar:summary..."
            npm run sonar:summary
          else
            echo "â„¹ï¸  Comando sonar:summary nÃ£o disponÃ­vel; pulando passo Sonar"
          fi

          echo "ğŸ“ˆ RelatÃ³rio: https://sonarcloud.io/project/overview?id=mayconaraujosantos_pillmind"
          echo "ğŸ’¡ Verifique o Problems Panel (Ctrl+Shift+M) no VS Code para issues detalhadas"
          echo "âœ… SonarQube double-check concluÃ­do!"
        fi
